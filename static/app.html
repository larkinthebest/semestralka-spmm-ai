<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Multimedia Tutor</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <div class="container">
      <!-- Left Panel -->
      <div class="left-panel">
        <div class="tutor-section">
          <div class="tutor-controls">
            <div class="tutor-selector">
              <div
                class="tutor-option tutor-enola active"
                onclick="selectTutor('enola')"
                title="Enola - Explanation Specialist"
              ></div>
              <div
                class="tutor-option tutor-franklin"
                onclick="selectTutor('franklin')"
                title="Franklin - Testing Specialist"
              ></div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div class="language-selector">
                <button class="language-btn" onclick="toggleLanguageDropdown()" id="languageBtn">
                  üåê EN
                </button>
                <div class="language-dropdown" id="languageDropdown">
                  <div class="language-option active" onclick="selectLanguage('en', 'EN')">
                    üá∫üá∏ English
                  </div>
                  <div class="language-option" onclick="selectLanguage('de', 'DE')">
                    üá©üá™ Deutsch
                  </div>
                  <div class="language-option" onclick="selectLanguage('sk', 'SK')">
                    üá∏üá∞ Slovenƒçina
                  </div>
                </div>
              </div>
              <button
                class="theme-toggle"
                onclick="toggleTheme()"
                id="themeToggle"
              >
                üåô
              </button>
            </div>
          </div>
          <div class="tutor-avatar" id="tutorAvatar"></div>
          <div class="tutor-name" id="tutorName">Enola</div>
          <div class="tutor-description" id="tutorDescription">
            I will explain the world to you
          </div>
        </div>

        <div class="user-section" id="userSection">
          <div id="userInfo" class="user-info">üë§ Guest User</div>
          <div id="authActions" class="auth-actions">
            <a href="/auth">Sign In</a>
          </div>
        </div>

        <div class="chats-section">
          <div class="section-header">
            <div class="section-title">Chats</div>
            <button class="add-btn" onclick="addNewChat()">+</button>
          </div>
          <div id="chatList">
            <div class="chat-item active" data-chat-id="1" onclick="switchToChat(1)">
              <span>New Chat</span>
              <div class="item-actions">
                <button class="action-btn" onclick="event.stopPropagation(); renameChat(1)">‚úèÔ∏è</button>
                <button class="action-btn" onclick="event.stopPropagation(); deleteChat(1)">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        </div>

        <div class="assets-section">
          <div class="section-header">
            <div class="section-title">Assets</div>
            <button class="add-btn" onclick="addAsset()">+</button>
          </div>
          <div id="assetList">
            <div class="no-assets-message">
              No assets uploaded
            </div>
          </div>
        </div>
      </div>

      <!-- Middle Panel -->
      <div class="middle-panel" id="middlePanel">
        <div class="drop-overlay" id="dropOverlay">
          üìé Drop files here to attach to message
        </div>

        <div class="mode-selector">
          <button
            class="mode-btn explanation active"
            onclick="switchToExplanationMode()"
            id="explanationModeBtn"
          >
            üß† Explanation Mode
          </button>
          <button 
            class="mode-btn testing" 
            onclick="switchToTestingMode()"
            id="testingModeBtn"
          >
            üìù Testing Mode
          </button>
        </div>

        <div class="chat-area" id="chatArea">
          <div class="message">
            <div class="message-avatar" id="initialAvatar"></div>
            <div class="message-content">
              Hello! I'm your AI tutor. Upload some files and I'll help you
              learn from them. Use <strong>Explanation Mode</strong> to ask
              questions and get detailed answers, or switch to
              <strong>Testing Mode</strong> to practice with quizzes.
              <br /><br />
              You can drag and drop files directly into the chat to attach them
              to your messages!
            </div>
          </div>
        </div>

        <div class="input-section">
          <div class="attached-files" id="attachedFiles"></div>
          <div class="input-container explanation" id="inputContainer">
            <button class="attach-btn" onclick="attachFile()">üìé</button>
            <input
              type="text"
              class="message-input"
              id="messageInput"
              placeholder="Ask me anything about your uploaded content..."
              onkeypress="handleKeyPress(event)"
            />
            <button
              class="send-btn explanation"
              id="sendBtn"
              onclick="sendMessage()"
            >
              ‚û§
            </button>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div class="source-panel">
          <h3>üìö Sources</h3>
          <div id="sourceList">
            <div class="no-sources-message">
              Sources will appear here when you ask questions
            </div>
          </div>
        </div>
        
        <!-- Quiz Panel (hidden by default) -->
        <div id="quizPanel" style="display: none;">
          <h3>üìù Interactive Quiz</h3>
          <div id="quizContainer"></div>
        </div>
      </div>
    </div>

    <!-- Hidden file inputs -->
    <input
      type="file"
      id="fileInput"
      class="hidden-input"
      title="Upload Asset"
      multiple
      accept=".pdf,.docx,.txt,.md,.jpg,.jpeg,.png,.gif,.bmp,.mp3,.wav,.m4a,.ogg,.mp4,.avi,.mov,.mkv,.webm"
      onchange="handleFileUpload(event, 'asset')"
    />

    <input
      type="file"
      id="attachInput"
      class="hidden-input"
      title="Attach to Message"
      multiple
      accept=".pdf,.docx,.txt,.md,.jpg,.jpeg,.png,.gif,.bmp,.mp3,.wav,.m4a,.ogg,.mp4,.avi,.mov,.mkv,.webm"
      onchange="handleFileUpload(event, 'attach')"
    />

    <!-- Modals -->
    <div id="renameModal" class="modal">
      <div class="modal-content">
        <h3>Rename Chat</h3>
        <input type="text" id="renameInput" placeholder="Enter new name" />
        <div class="modal-buttons">
          <button
            class="modal-btn secondary"
            onclick="closeModal('renameModal')"
          >
            Cancel
          </button>
          <button class="modal-btn primary" onclick="confirmRename()">
            Rename
          </button>
        </div>
      </div>
    </div>

    <script>
      let currentMode = "explanation";
      let currentTutor = "enola";
      let currentChatId = 1;
      let chatCounter = 1;
      let assetCounter = 0;
      let attachedFiles = [];
      let chatModeHistory = {};
      let currentChatFiles = [];
      let chatSources = {};  // Store sources per chat
      let chatTitles = {};   // Store chat titles
      let currentLanguage = 'en';
      let currentQuiz = null;
      let quizAnswers = {};

      // Theme management
      function toggleTheme() {
        const body = document.body;
        const themeToggle = document.getElementById("themeToggle");

        if (body.getAttribute("data-theme") === "dark") {
          body.removeAttribute("data-theme");
          themeToggle.textContent = "üåô";
          localStorage.setItem("theme", "light");
        } else {
          body.setAttribute("data-theme", "dark");
          themeToggle.textContent = "‚òÄÔ∏è";
          localStorage.setItem("theme", "dark");
        }
      }

      // Load saved theme
      function loadTheme() {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "dark") {
          document.body.setAttribute("data-theme", "dark");
          document.getElementById("themeToggle").textContent = "‚òÄÔ∏è";
        }
      }

      // Tutor selection with enforced specialization
      function selectTutor(tutor) {
        currentTutor = tutor;
        
        // ENFORCE TUTOR-MODE PAIRING
        if (tutor === "enola") {
          currentMode = "explanation";
        } else if (tutor === "franklin") {
          currentMode = "testing";
        }

        updateTutorDisplay();
        updateModeDisplay();
        loadModeHistory();
        
        // Show tutor switch notification
        const modeText = tutor === 'enola' ? 'Explanation Mode' : 'Testing Mode';
        showNotification(`Switched to ${tutor.charAt(0).toUpperCase() + tutor.slice(1)} - ${modeText}`, 'info');
      }
      
      function updateTutorDisplay() {
        // Update active tutor option
        document.querySelectorAll(".tutor-option").forEach((option) => {
          option.classList.remove("active");
        });
        document.querySelector(`.tutor-${currentTutor}`).classList.add("active");

        // Update tutor info
        const tutorAvatar = document.getElementById("tutorAvatar");
        const tutorName = document.getElementById("tutorName");
        const tutorDescription = document.getElementById("tutorDescription");
        const initialAvatar = document.getElementById("initialAvatar");

        if (currentTutor === "enola") {
          tutorAvatar.style.backgroundImage = "url('/static/enola.jpg')";
          if (initialAvatar) initialAvatar.style.backgroundImage = "url('/static/enola.jpg')";
          tutorName.textContent = "Enola";
          tutorDescription.textContent = "I will explain the world to you";
        } else {
          tutorAvatar.style.backgroundImage = "url('/static/tutor.png')";
          if (initialAvatar) initialAvatar.style.backgroundImage = "url('/static/tutor.png')";
          tutorName.textContent = "Franklin";
          tutorDescription.textContent = "I will test your *ss";
        }

        // Update all bot message avatars
        document.querySelectorAll(".message:not(.user) .message-avatar").forEach((avatar) => {
          if (currentTutor === "enola") {
            avatar.style.backgroundImage = "url('/static/enola.jpg')";
          } else {
            avatar.style.backgroundImage = "url('/static/tutor.png')";
          }
        });
      }

      // Drag and drop functionality
      function setupDragAndDrop() {
        const middlePanel = document.getElementById("middlePanel");
        const dropOverlay = document.getElementById("dropOverlay");

        middlePanel.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropOverlay.classList.add("active");
        });

        middlePanel.addEventListener("dragleave", (e) => {
          if (!middlePanel.contains(e.relatedTarget)) {
            dropOverlay.classList.remove("active");
          }
        });

        middlePanel.addEventListener("drop", (e) => {
          e.preventDefault();
          dropOverlay.classList.remove("active");

          const files = Array.from(e.dataTransfer.files);
          files.forEach((file) => {
            attachFileToMessage(file);
          });
        });
      }

      function attachFileToMessage(file) {
        attachedFiles.push(file);
        updateAttachedFilesDisplay();
      }

      function updateAttachedFilesDisplay() {
        const container = document.getElementById("attachedFiles");
        container.innerHTML = "";

        attachedFiles.forEach((file, index) => {
          const fileDiv = document.createElement("div");
          fileDiv.className = "attached-file";
          fileDiv.innerHTML = `
                    <span>üìÑ ${file.name}</span>
                    <button class="remove-attachment" onclick="removeAttachment(${index})">√ó</button>
                `;
          container.appendChild(fileDiv);
        });
      }

      function removeAttachment(index) {
        attachedFiles.splice(index, 1);
        updateAttachedFilesDisplay();
      }

      // Mode switching functions that also switch tutors
      function switchToExplanationMode() {
        if (currentTutor !== "enola") {
          selectTutor("enola");  // This will also set explanation mode
        } else {
          currentMode = "explanation";
          updateModeDisplay();
          loadModeHistory();
        }
      }
      
      function switchToTestingMode() {
        if (currentTutor !== "franklin") {
          selectTutor("franklin");  // This will also set testing mode
        } else {
          currentMode = "testing";
          updateModeDisplay();
          loadModeHistory();
        }
      }
      
      // Legacy function for compatibility
      function setMode(mode) {
        if (mode === "explanation") {
          switchToExplanationMode();
        } else {
          switchToTestingMode();
        }
      }
      
      function updateModeDisplay() {
        const explanationBtn = document.getElementById("explanationModeBtn");
        const testingBtn = document.getElementById("testingModeBtn");
        const inputContainer = document.getElementById("inputContainer");
        const sendBtn = document.getElementById("sendBtn");
        const input = document.getElementById("messageInput");
        
        // Reset all button states
        explanationBtn.classList.remove("active");
        testingBtn.classList.remove("active");
        explanationBtn.disabled = false;
        testingBtn.disabled = false;
        explanationBtn.style.opacity = "1";
        testingBtn.style.opacity = "1";
        
        // Apply current mode styling
        if (currentMode === "explanation") {
          explanationBtn.classList.add("active");
          inputContainer.className = "input-container explanation";
          sendBtn.className = "send-btn explanation";
          input.placeholder = "Ask me to explain concepts from your files...";
        } else {
          testingBtn.classList.add("active");
          inputContainer.className = "input-container testing";
          sendBtn.className = "send-btn testing";
          input.placeholder = "Ask me to create quizzes from your files...";
        }
      }
      
      function loadModeHistory() {
        const chatKey = `${currentChatId}_${currentMode}`;
        const chatArea = document.getElementById("chatArea");
        
        if (chatModeHistory[chatKey] && chatModeHistory[chatKey].length > 0) {
          chatArea.innerHTML = '';
          // Always show initial welcome message first
          const avatarUrl = currentTutor === "enola" ? "/static/enola.jpg" : "/static/tutor.png";
          let welcomeMsg;
          if (currentTutor === "enola") {
            welcomeMsg = `Hello! I'm <strong>Enola</strong>, your explanation tutor! üìö<br><br>I specialize in <strong>detailed explanations</strong> and helping you understand concepts from your study materials. I'll break down complex topics, provide examples, and make learning enjoyable!<br><br><strong>Upload files and ask me to explain anything!</strong> üòä`;
          } else {
            welcomeMsg = `Greetings! I'm <strong>Franklin</strong>, your testing tutor. üìù<br><br>I specialize in <strong>quizzes and assessments</strong> to help you practice and test your knowledge. I'll create structured questions, multiple choice tests, and comprehensive evaluations based on your materials.<br><br><strong>Upload study materials and let's test your knowledge!</strong> üéØ`;
          }
          
          chatArea.innerHTML = `
            <div class="message">
              <div class="message-avatar" style="background-image: url('${avatarUrl}')"></div>
              <div class="message-content">${welcomeMsg}</div>
            </div>
          `;
          
          // Then add chat history
          chatModeHistory[chatKey].forEach(msg => {
            addMessage(msg.content, msg.type);
          });
        } else {
          const avatarUrl = currentTutor === "enola" ? "/static/enola.jpg" : "/static/tutor.png";
          
          let welcomeMsg;
          if (currentTutor === "enola") {
            welcomeMsg = `Hello! I'm <strong>Enola</strong>, your explanation tutor! üìö<br><br>I specialize in <strong>detailed explanations</strong> and helping you understand concepts from your study materials. I'll break down complex topics, provide examples, and make learning enjoyable!<br><br><strong>Upload files and ask me to explain anything!</strong> üòä`;
          } else {
            welcomeMsg = `Greetings! I'm <strong>Franklin</strong>, your testing tutor. üìù<br><br>I specialize in <strong>quizzes and assessments</strong> to help you practice and test your knowledge. I'll create structured questions, multiple choice tests, and comprehensive evaluations based on your materials.<br><br><strong>Upload study materials and let's test your knowledge!</strong> üéØ`;
          }
          
          chatArea.innerHTML = `
            <div class="message">
              <div class="message-avatar" style="background-image: url('${avatarUrl}')"></div>
              <div class="message-content">${welcomeMsg}</div>
            </div>
          `;
        }
      }
      
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 20px;
          border-radius: 8px;
          color: white;
          font-weight: bold;
          z-index: 1000;
          max-width: 300px;
          animation: slideIn 0.3s ease;
        `;
        
        if (type === 'warning') {
          notification.style.background = '#ff9800';
        } else {
          notification.style.background = '#2196f3';
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 4000);
      }

      // Chat management
      function switchToChat(chatId) {
        // Save current chat before switching
        saveChatToDatabase();
        
        // Remove active class from all chats
        document.querySelectorAll(".chat-item").forEach((item) => {
          item.classList.remove("active");
        });
        
        // Add active class to selected chat
        const selectedChat = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (selectedChat) {
          selectedChat.classList.add("active");
          currentChatId = parseInt(chatId);
          
          // Load chat history for this chat and current mode
          loadModeHistory();
          
          // Load sources for this chat
          loadChatSources(chatId);
        }
      }
      
      function addNewChat() {
        // Save current chat before creating new one
        saveChatToDatabase();
        
        chatCounter++;
        const chatList = document.getElementById("chatList");

        // Remove active class from all chats
        document.querySelectorAll(".chat-item").forEach((item) => {
          item.classList.remove("active");
        });

        const newChat = document.createElement("div");
        newChat.className = "chat-item active";
        newChat.setAttribute("data-chat-id", chatCounter);
        newChat.setAttribute("onclick", `switchToChat(${chatCounter})`);
        newChat.innerHTML = `
                <span>New Chat</span>
                <div class="item-actions">
                    <button class="action-btn" onclick="event.stopPropagation(); renameChat(${chatCounter})">‚úèÔ∏è</button>
                    <button class="action-btn" onclick="event.stopPropagation(); deleteChat(${chatCounter})">üóëÔ∏è</button>
                </div>
            `;

        chatList.appendChild(newChat);
        currentChatId = chatCounter;
        
        // Initialize chat title
        chatTitles[chatCounter] = "New Chat";
        
        // Clear sources for new chat
        chatSources[chatCounter] = [];
        updateSources([]);

        // Clear chat area and load welcome message
        loadModeHistory();
      }

      function renameChat(chatId) {
        const modal = document.getElementById("renameModal");
        const input = document.getElementById("renameInput");
        const chatItem = document.querySelector(
          `[data-chat-id="${chatId}"] span`
        );

        input.value = chatItem.textContent;
        modal.style.display = "block";
        modal.setAttribute("data-chat-id", chatId);
      }

      function confirmRename() {
        const modal = document.getElementById("renameModal");
        const chatId = modal.getAttribute("data-chat-id");
        const newName = document.getElementById("renameInput").value;

        if (newName.trim()) {
          const chatItem = document.querySelector(
            `[data-chat-id="${chatId}"] span`
          );
          chatItem.textContent = newName;
          
          // Update local storage
          chatTitles[chatId] = newName;
          
          // Save to database
          saveChatToDatabase();
        }

        closeModal("renameModal");
      }

      async function deleteChat(chatId) {
        if (confirm("Are you sure you want to delete this chat?")) {
          try {
            // Delete from database
            const response = await fetch(`/chats/${chatId}`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
              }
            });
            
            // Remove from UI
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (chatItem) {
              chatItem.remove();
            }
            
            // Clean up local data
            delete chatTitles[chatId];
            delete chatSources[chatId];
            Object.keys(chatModeHistory).forEach(key => {
              if (key.startsWith(`${chatId}_`)) {
                delete chatModeHistory[key];
              }
            });

            // If this was the active chat, switch to another one
            if (currentChatId == chatId) {
              const remainingChats = document.querySelectorAll(".chat-item");
              if (remainingChats.length > 0) {
                const newChatId = remainingChats[0].getAttribute("data-chat-id");
                switchToChat(newChatId);
              } else {
                // Create a new chat if none remain
                addNewChat();
              }
            }
          } catch (error) {
            console.error('Error deleting chat:', error);
          }
        }
      }

      // Asset management
      function addAsset() {
        document.getElementById("fileInput").click();
      }

      function attachFile() {
        document.getElementById("attachInput").click();
      }

      async function handleFileUpload(event, type) {
        const files = event.target.files;

        if (type === "attach") {
          // Add to message attachments
          Array.from(files).forEach((file) => {
            attachFileToMessage(file);
          });
        } else {
          // Add to assets
          await addFilesToAssets(files);
        }

        // Clear input
        event.target.value = "";
      }

      async function addFilesToAssets(files) {
        const assetList = document.getElementById("assetList");

        // Clear "no assets" message
        if (assetCounter === 0) {
          assetList.innerHTML = "";
        }

        for (let file of files) {
          assetCounter++;

          // Get file icon based on type
          const fileIcon = getFileIcon(file.name);

          // Add to UI
          const assetItem = document.createElement("div");
          assetItem.className = "asset-item";
          assetItem.setAttribute("data-asset-id", assetCounter);
          assetItem.innerHTML = `
                    <span>${fileIcon} ${file.name}</span>
                    <div class="item-actions">
                        <button class="action-btn" onclick="renameAsset(${assetCounter})">‚úèÔ∏è</button>
                        <button class="action-btn" onclick="deleteAsset(${assetCounter})">üóëÔ∏è</button>
                    </div>
                `;
          assetList.appendChild(assetItem);

          // Upload file
          await uploadFile(file);
        }
      }

      function getFileIcon(filename) {
        const extension = filename.split(".").pop().toLowerCase();

        if (["jpg", "jpeg", "png", "gif", "bmp"].includes(extension)) {
          return "üñºÔ∏è";
        } else if (["mp3", "wav", "m4a", "ogg"].includes(extension)) {
          return "üéµ";
        } else if (["mp4", "avi", "mov", "mkv", "webm"].includes(extension)) {
          return "üé¨";
        } else if (["pdf"].includes(extension)) {
          return "üìï";
        } else if (["docx", "doc"].includes(extension)) {
          return "üìò";
        } else if (["txt"].includes(extension)) {
          return "üìÑ";
        } else {
          return "üìé";
        }
      }

      async function uploadFile(file) {
        const formData = new FormData();
        formData.append("file", file);

        try {
          const response = await fetch("/documents/upload", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            console.log("File uploaded successfully:", file.name);
          } else {
            console.error("Upload failed for:", file.name);
          }
        } catch (error) {
          console.error("Upload error:", error);
        }
      }

      async function deleteAsset(assetId) {
        if (confirm("Are you sure you want to delete this asset?")) {
          const assetItem = document.querySelector(`[data-asset-id="${assetId}"]`);
          const filename = assetItem.querySelector('span').textContent.split(' ').slice(1).join(' ');
          
          try {
            // Call backend to delete file (if implemented)
            // For now, just remove from UI
            assetItem.remove();
            
            // Remove from current chat files if present
            const index = currentChatFiles.indexOf(filename);
            if (index > -1) {
              currentChatFiles.splice(index, 1);
            }

            // Check if no assets left
            const remainingAssets = document.querySelectorAll(".asset-item");
            if (remainingAssets.length === 0) {
              document.getElementById("assetList").innerHTML = `
                <div class="no-assets-message">
                  No assets uploaded
                </div>
              `;
              assetCounter = 0;
            }
          } catch (error) {
            console.error('Error deleting asset:', error);
          }
        }
      }

      // Chat functionality
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (!message && attachedFiles.length === 0) return;
        
        // Get all available files (assets + current chat files)
        const allAvailableFiles = [...new Set([...currentChatFiles, ...attachedFiles.map(f => f.name)])];
        
        // Check if files are required
        if (allAvailableFiles.length === 0) {
          showNotification("Please upload files first! Use the + button in Assets or drag files here.", "warning");
          return;
        }

        // Show loading animation
        showLoadingMessage();

        // Upload attached files to assets first
        if (attachedFiles.length > 0) {
          await addFilesToAssets(attachedFiles);
          attachedFiles.forEach(file => {
            if (!currentChatFiles.includes(file.name)) {
              currentChatFiles.push(file.name);
            }
          });
        }

        // Create message content
        let messageContent = message;
        let attachmentHtml = "";

        if (attachedFiles.length > 0) {
          attachmentHtml = '<div class="message-attachments">';
          attachedFiles.forEach((file) => {
            const fileIcon = getFileIcon(file.name);
            attachmentHtml += `<div class="attachment-preview">${fileIcon} ${file.name}</div>`;
          });
          attachmentHtml += "</div>";
        }

        // Add user message
        addMessage(messageContent + attachmentHtml, "user");
        input.value = "";

        // Store in mode-specific history
        const chatKey = `${currentChatId}_${currentMode}`;
        if (!chatModeHistory[chatKey]) {
          chatModeHistory[chatKey] = [];
        }
        chatModeHistory[chatKey].push({type: 'user', content: messageContent + attachmentHtml});
        
        // Save to localStorage for persistence
        localStorage.setItem('chatModeHistory', JSON.stringify(chatModeHistory));

        const fileNames = attachedFiles.map(f => f.name);
        attachedFiles = [];
        updateAttachedFilesDisplay();

        try {
          const response = await fetch("/simple-chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              mode: currentMode,
              tutor: currentTutor,
              chat_id: currentChatId,
              attached_files: allAvailableFiles,
              language: currentLanguage
            }),
          });

          const data = await response.json();
          
          // Remove loading message
          removeLoadingMessage();
          
          if (data.requires_files) {
            showNotification("Please upload files first!", "warning");
            return;
          }
          
          addMessage(data.response, "bot");
          
          chatModeHistory[chatKey].push({type: 'bot', content: data.response});
          
          // Save to localStorage
          localStorage.setItem('chatModeHistory', JSON.stringify(chatModeHistory));

          // Auto-rename chat only once with unique titles
          if (data.suggested_title) {
            const chatItem = document.querySelector(`[data-chat-id="${currentChatId}"] span`);
            if (chatItem && (chatItem.textContent === 'New Chat' || chatItem.textContent.startsWith('New Chat'))) {
              // Ensure unique title
              let uniqueTitle = data.suggested_title;
              let counter = 1;
              while (Object.values(chatTitles).includes(uniqueTitle)) {
                uniqueTitle = `${data.suggested_title} (${counter})`;
                counter++;
              }
              chatItem.textContent = uniqueTitle;
              chatTitles[currentChatId] = uniqueTitle;
            }
          }

          // Check if Franklin generated a quiz and display interactive version
          if (currentTutor === 'franklin' && data.response.includes('üìù **Quiz:')) {
            const quizData = parseQuizFromResponse(data.response);
            if (quizData && quizData.questions.length > 0) {
              displayQuiz(quizData);
            }
          }
          
          // Update sources for this specific chat
          if (data.sources) {
            chatSources[currentChatId] = data.sources;
            updateSources(data.sources, allAvailableFiles);
          }
          
          // Save chat to database
          saveChatToDatabase();
        } catch (error) {
          removeLoadingMessage();
          addMessage("Sorry, I encountered an error. Please try again.", "bot");
        }
      }

      function addMessage(text, sender) {
        const chatArea = document.getElementById("chatArea");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateY(20px)';
        messageDiv.style.transition = 'all 0.3s ease';

        const avatarUrl =
          sender === "user"
            ? ""
            : currentTutor === "enola"
            ? "/static/enola.jpg"
            : "/static/tutor.png";

        // Format text for better display
        const formattedText = formatMessageText(text);

        messageDiv.innerHTML = `
                <div class="message-avatar" style="background-image: url('${avatarUrl}')"></div>
                <div class="message-content">${formattedText}</div>
            `;

        chatArea.appendChild(messageDiv);
        
        // Animate message appearance
        setTimeout(() => {
          messageDiv.style.opacity = '1';
          messageDiv.style.transform = 'translateY(0)';
        }, 50);
        
        chatArea.scrollTop = chatArea.scrollHeight;
      }
      
      function formatMessageText(text) {
        // Convert comprehensive markdown formatting to HTML
        return text
          .replace(/### (.*?)$/gm, '<h3>$1</h3>')           // H3 headings
          .replace(/## (.*?)$/gm, '<h2>$1</h2>')            // H2 headings
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
          .replace(/\*(.*?)\*/g, '<em>$1</em>')             // Italic
          .replace(/`(.*?)`/g, '<code>$1</code>')           // Inline code
          .replace(/^> (.*?)$/gm, '<blockquote>$1</blockquote>') // Blockquotes
          .replace(/‚Ä¢ /g, '&bull; ')                       // Bullet points
          .replace(/^(\d+\. .*?)$/gm, '<ol><li>$1</li></ol>') // Numbered lists (basic)
          .replace(/\|(.*)\|/g, '<table><tr><td>$1</td></tr></table>') // Basic tables
          .replace(/\n\n/g, '<br><br>')                     // Double line breaks
          .replace(/\n/g, '<br>');                          // Single line breaks
      }

      function updateSources(sources, usedFiles = []) {
        const sourceList = document.getElementById("sourceList");
        sourceList.innerHTML = "";

        if (!sources || sources.length === 0) {
          sourceList.innerHTML = `
            <div class="no-sources-message">
              <div style="color: var(--text-secondary); font-size: 14px; text-align: center; padding: 20px;">
                No sources used in current response
              </div>
            </div>`;
          return;
        }

        // Add header for current chat sources
        const headerDiv = document.createElement("div");
        headerDiv.innerHTML = `
          <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; padding: 0 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">
            üìÑ Files used in this chat:
          </div>
        `;
        sourceList.appendChild(headerDiv);

        sources.forEach((source) => {
          const sourceItem = document.createElement("div");
          sourceItem.className = "source-item";
          
          const fileIcon = getFileIcon(source.title);
          const typeInfo = source.type ? `${source.type.toUpperCase()} ‚Ä¢ ` : '';
          const wordInfo = source.word_count ? `${source.word_count} words` : '';
          
          // Generate thumbnail for images and videos
          let thumbnailHtml = '';
          const extension = source.title.split('.').pop().toLowerCase();
          
          if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(extension)) {
            thumbnailHtml = `
              <div class="source-thumbnail">
                <img src="/uploads/${source.title}" alt="${source.title}" 
                     style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 8px;" 
                     onerror="this.style.display='none'">
              </div>`;
          } else if (['mp4', 'avi', 'mov', 'mkv', 'webm'].includes(extension)) {
            thumbnailHtml = `
              <div class="source-thumbnail">
                <video style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 8px;" 
                       muted>
                  <source src="/uploads/${source.title}" type="video/${extension}">
                </video>
              </div>`;
          }
          
          sourceItem.innerHTML = `
            <div style="display: flex; align-items: flex-start; gap: 8px;" onclick="previewFile('${source.title}', '${extension}')" style="cursor: pointer;">
              ${thumbnailHtml}
              <div style="flex: 1;">
                <div class="source-title">${fileIcon} ${source.title}</div>
                <div class="source-meta" style="font-size: 12px; color: var(--text-secondary); margin: 4px 0;">
                  ${typeInfo}${wordInfo}
                </div>
                <div class="source-excerpt">${source.excerpt}</div>
              </div>
            </div>
          `;
          
          // Add click handler for file preview
          sourceItem.style.cursor = 'pointer';
          sourceItem.addEventListener('click', () => previewFile(source.title, extension));
          sourceList.appendChild(sourceItem);
        });
      }
      
      function loadChatSources(chatId) {
        const sources = chatSources[chatId] || [];
        updateSources(sources);
      }
      
      function showLoadingMessage() {
        const chatArea = document.getElementById("chatArea");
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "message loading-message";
        loadingDiv.id = "loadingMessage";
        
        const avatarUrl = currentTutor === "enola" ? "/static/enola.jpg" : "/static/tutor.png";
        
        loadingDiv.innerHTML = `
          <div class="message-avatar" style="background-image: url('${avatarUrl}')"></div>
          <div class="message-content">
            <div class="loading-spinner"></div>
            Thinking...
          </div>
        `;
        
        chatArea.appendChild(loadingDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }
      
      function removeLoadingMessage() {
        const loadingMsg = document.getElementById("loadingMessage");
        if (loadingMsg) {
          loadingMsg.remove();
        }
      }

      // Utility functions
      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // Close modals when clicking outside
      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };

      // Authentication functions
      function checkAuthStatus() {
        const token = localStorage.getItem('access_token');
        const user = localStorage.getItem('user');
        
        if (token && user) {
          const userData = JSON.parse(user);
          document.getElementById('userInfo').innerHTML = `üë§ ${userData.username}`;
          document.getElementById('authActions').innerHTML = `
            <a href="#" onclick="logout()">Sign Out</a>
          `;
        }
      }
      
      function logout() {
        // Add fade out animation
        document.body.style.transition = 'opacity 0.3s ease';
        document.body.style.opacity = '0';
        
        setTimeout(() => {
          localStorage.removeItem('access_token');
          localStorage.removeItem('user');
          localStorage.removeItem('chatModeHistory');
          localStorage.removeItem('selectedLanguage');
          location.reload();
        }, 300);
      }
      
      // Chat persistence functions
      async function saveChatToDatabase() {
        if (!currentChatId) return;
        
        const chatKey = `${currentChatId}_${currentMode}`;
        const messages = chatModeHistory[chatKey] || [];
        const title = chatTitles[currentChatId] || "New Chat";
        const filesUsed = chatSources[currentChatId] || [];
        
        try {
          await fetch('/chats/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
            },
            body: JSON.stringify({
              chat_id: currentChatId,
              title: title,
              mode: currentMode,
              tutor: currentTutor,
              messages: messages,
              files_used: filesUsed.map(s => s.title)
            })
          });
        } catch (error) {
          console.error('Error saving chat:', error);
        }
      }
      
      async function loadChatsFromDatabase() {
        try {
          const response = await fetch('/chats/list', {
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('access_token') || ''}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const chatList = document.getElementById('chatList');
            
            // Clear existing chats except the default one
            chatList.innerHTML = '';
            
            if (data.chats && data.chats.length > 0) {
              data.chats.forEach((chat, index) => {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${index === 0 ? 'active' : ''}`;
                chatItem.setAttribute('data-chat-id', chat.chat_id);
                chatItem.setAttribute('onclick', `switchToChat(${chat.chat_id})`);
                chatItem.innerHTML = `
                  <span>${chat.title}</span>
                  <div class="item-actions">
                    <button class="action-btn" onclick="event.stopPropagation(); renameChat(${chat.chat_id})">‚úèÔ∏è</button>
                    <button class="action-btn" onclick="event.stopPropagation(); deleteChat(${chat.chat_id})">üóëÔ∏è</button>
                  </div>
                `;
                chatList.appendChild(chatItem);
                
                // Restore chat data
                chatTitles[chat.chat_id] = chat.title;
                if (chat.messages) {
                  const chatKey = `${chat.chat_id}_${chat.mode}`;
                  chatModeHistory[chatKey] = chat.messages;
                }
                if (chat.files_used) {
                  chatSources[chat.chat_id] = chat.files_used.map(filename => ({title: filename}));
                }
                
                if (index === 0) {
                  currentChatId = chat.chat_id;
                  currentMode = chat.mode;
                  currentTutor = chat.tutor;
                }
              });
              
              chatCounter = Math.max(...data.chats.map(c => c.chat_id));
            } else {
              // Create default chat if none exist
              addNewChat();
            }
          }
        } catch (error) {
          console.error('Error loading chats:', error);
          // Create default chat on error
          addNewChat();
        }
      }
      
      // Auto-save chat periodically (reduced frequency)
      setInterval(saveChatToDatabase, 120000); // Save every 2 minutes
      
      // Save chat before page unload
      window.addEventListener('beforeunload', saveChatToDatabase);

      // Language management
      function toggleLanguageDropdown() {
        document.getElementById('languageDropdown').classList.toggle('show');
      }
      
      function selectLanguage(code, display) {
        currentLanguage = code;
        document.getElementById('languageBtn').innerHTML = `üåê ${display}`;
        document.getElementById('languageDropdown').classList.remove('show');
        document.querySelectorAll('.language-option').forEach(opt => opt.classList.remove('active'));
        event.target.classList.add('active');
        localStorage.setItem('selectedLanguage', code);
        showNotification(`Language changed to ${display}`, 'info');
      }
      
      // Quiz management
      function displayQuiz(quizData) {
        const quizPanel = document.getElementById('quizPanel');
        const quizContainer = document.getElementById('quizContainer');
        const sourcePanel = document.querySelector('.source-panel');
        
        currentQuiz = quizData;
        quizAnswers = {};
        
        quizPanel.style.display = 'block';
        sourcePanel.style.display = 'none';
        
        let quizHtml = `
          <div class="quiz-container">
            <div class="quiz-header">
              <div class="quiz-title">${quizData.title || 'Interactive Quiz'}</div>
              <div class="quiz-progress">Question 1 of ${quizData.questions.length}</div>
            </div>
            <div id="quizQuestions">
        `;
        
        quizData.questions.forEach((question, index) => {
          quizHtml += `
            <div class="quiz-question" id="question-${index}" style="${index === 0 ? '' : 'display: none;'}">
              <div class="question-text">${index + 1}. ${question.question}</div>
          `;
          
          if (question.type === 'multiple_choice') {
            quizHtml += '<div class="quiz-options">';
            question.options.forEach((option, optIndex) => {
              const letter = String.fromCharCode(65 + optIndex);
              quizHtml += `
                <div class="quiz-option" onclick="selectQuizOption(${index}, '${letter}', this)">
                  <span class="option-letter">${letter})</span>
                  <span>${option}</span>
                </div>
              `;
            });
            quizHtml += '</div>';
          } else if (question.type === 'true_false') {
            quizHtml += `
              <div class="quiz-options">
                <div class="quiz-option" onclick="selectQuizOption(${index}, 'True', this)">
                  <span class="option-letter">T)</span>
                  <span>True</span>
                </div>
                <div class="quiz-option" onclick="selectQuizOption(${index}, 'False', this)">
                  <span class="option-letter">F)</span>
                  <span>False</span>
                </div>
              </div>
            `;
          } else if (question.type === 'short_answer') {
            quizHtml += `
              <textarea class="quiz-input" placeholder="Write your answer in 2-3 sentences..." 
                       onchange="quizAnswers[${index}] = this.value" rows="3"></textarea>
            `;
          }
          
          quizHtml += '</div>';
        });
        
        quizHtml += `
            </div>
            <div class="quiz-actions">
              <button class="quiz-btn secondary" onclick="previousQuestion()" id="prevBtn" style="display: none;">Previous</button>
              <button class="quiz-btn primary" onclick="nextQuestion()" id="nextBtn">Next</button>
              <button class="quiz-btn primary" onclick="submitQuiz()" id="submitBtn" style="display: none;">Submit Quiz</button>
            </div>
          </div>
        `;
        
        quizContainer.innerHTML = quizHtml;
      }
      
      function selectQuizOption(questionIndex, answer, element) {
        element.parentNode.querySelectorAll('.quiz-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        element.classList.add('selected');
        quizAnswers[questionIndex] = answer;
      }
      
      let currentQuestionIndex = 0;
      
      function nextQuestion() {
        const questions = document.querySelectorAll('.quiz-question');
        if (currentQuestionIndex < questions.length - 1) {
          questions[currentQuestionIndex].style.display = 'none';
          currentQuestionIndex++;
          questions[currentQuestionIndex].style.display = 'block';
          
          document.querySelector('.quiz-progress').textContent = 
            `Question ${currentQuestionIndex + 1} of ${questions.length}`;
          
          document.getElementById('prevBtn').style.display = 'inline-block';
          
          if (currentQuestionIndex === questions.length - 1) {
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'inline-block';
          }
        }
      }
      
      function previousQuestion() {
        const questions = document.querySelectorAll('.quiz-question');
        if (currentQuestionIndex > 0) {
          questions[currentQuestionIndex].style.display = 'none';
          currentQuestionIndex--;
          questions[currentQuestionIndex].style.display = 'block';
          
          document.querySelector('.quiz-progress').textContent = 
            `Question ${currentQuestionIndex + 1} of ${questions.length}`;
          
          if (currentQuestionIndex === 0) {
            document.getElementById('prevBtn').style.display = 'none';
          }
          
          document.getElementById('nextBtn').style.display = 'inline-block';
          document.getElementById('submitBtn').style.display = 'none';
        }
      }
      
      function submitQuiz() {
        if (!currentQuiz) return;
        
        let score = 0;
        currentQuiz.questions.forEach((question, index) => {
          if (quizAnswers[index] === question.correct_answer) {
            score++;
          }
        });
        
        const percentage = Math.round((score / currentQuiz.questions.length) * 100);
        const quizContainer = document.getElementById('quizContainer');
        
        let resultsHtml = `
          <div class="quiz-results">
            <div class="quiz-score">Score: ${score}/${currentQuiz.questions.length} (${percentage}%)</div>
            <div class="quiz-feedback">
              ${percentage >= 80 ? 'Excellent work! üéâ' : 
                percentage >= 60 ? 'Good job! Keep practicing. üëç' : 
                'Keep studying and try again! üìö'}
            </div>
          </div>
        `;
        
        // Show detailed results for each question
        currentQuiz.questions.forEach((question, index) => {
          const userAnswer = quizAnswers[index];
          const correctAnswer = question.correct_answer || 'A';
          const isCorrect = userAnswer === correctAnswer;
          
          resultsHtml += `
            <div class="quiz-question">
              <div class="question-text">${index + 1}. ${question.question}</div>
              <div class="quiz-option ${isCorrect ? 'correct' : 'incorrect'}">
                Your answer: ${userAnswer || 'Not answered'}
              </div>
              ${!isCorrect && question.type !== 'short_answer' ? `
                <div class="quiz-option correct">
                  Correct answer: ${correctAnswer}
                </div>
              ` : ''}
            </div>
          `;
        });
        
        resultsHtml += `
          <div class="quiz-actions">
            <button class="quiz-btn secondary" onclick="hideQuiz()">Close Quiz</button>
            <button class="quiz-btn primary" onclick="retakeQuiz()">Retake Quiz</button>
          </div>
        `;
        
        quizContainer.innerHTML = resultsHtml;
      }
      
      function retakeQuiz() {
        if (currentQuiz) {
          currentQuestionIndex = 0;
          displayQuiz(currentQuiz);
        }
      }
      
      function hideQuiz() {
        document.getElementById('quizPanel').style.display = 'none';
        document.querySelector('.source-panel').style.display = 'block';
        currentQuiz = null;
        quizAnswers = {};
      }
      
      // Enhanced quiz parsing from Franklin's response
      function parseQuizFromResponse(response) {
        try {
          const lines = response.split('\n');
          const questions = [];
          let currentQuestion = null;
          let questionCount = 0;
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // Detect question start
            if (line.match(/^\*\*Question \d+:\*\*/)) {
              if (currentQuestion) questions.push(currentQuestion);
              questionCount++;
              currentQuestion = {
                question: line.replace(/^\*\*Question \d+:\*\*\s*/, ''),
                type: 'multiple_choice',
                options: [],
                correct_answer: 'A'
              };
            }
            // Detect multiple choice options
            else if (line.match(/^\*\*[A-D]\)\*\*/)) {
              if (currentQuestion) {
                currentQuestion.options.push(line.replace(/^\*\*[A-D]\)\*\*\s*/, ''));
              }
            }
            // Detect True/False questions
            else if (line.includes('True or False')) {
              if (currentQuestion) {
                currentQuestion.type = 'true_false';
                currentQuestion.options = ['True', 'False'];
              }
            }
            // Detect short answer questions
            else if (line.includes('Write your answer') || line.includes('2-3 sentences')) {
              if (currentQuestion) {
                currentQuestion.type = 'short_answer';
                currentQuestion.options = [];
              }
            }
          }
          
          if (currentQuestion) questions.push(currentQuestion);
          
          return questions.length > 0 ? {
            title: 'Interactive Quiz',
            questions: questions
          } : null;
          
        } catch (error) {
          console.error('Quiz parsing error:', error);
          return null;
        }
      }
      
      document.addEventListener('click', function(event) {
        if (!event.target.closest('.language-selector')) {
          document.getElementById('languageDropdown').classList.remove('show');
        }
      });

      // Initialize
      document.addEventListener("DOMContentLoaded", async function () {
        loadTheme();
        setupDragAndDrop();
        checkAuthStatus();
        
        // Load chat history from localStorage as fallback
        const savedHistory = localStorage.getItem('chatModeHistory');
        if (savedHistory) {
          try {
            chatModeHistory = JSON.parse(savedHistory);
          } catch (e) {
            console.error('Error loading chat history:', e);
          }
        }
        
        // Initialize with Enola
        currentTutor = "enola";
        currentMode = "explanation";
        updateTutorDisplay();
        updateModeDisplay();
        
        // Load chats from database
        await loadChatsFromDatabase();
        
        // Load saved language
        const savedLanguage = localStorage.getItem('selectedLanguage');
        if (savedLanguage) {
          const langMap = {en: 'EN', de: 'DE', sk: 'SK'};
          if (langMap[savedLanguage]) {
            currentLanguage = savedLanguage;
            document.getElementById('languageBtn').innerHTML = `üåê ${langMap[savedLanguage]}`;
          }
        }
        
        // Load initial chat
        loadModeHistory();
      });
      
      // File preview function
      function previewFile(filename, extension) {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.8); z-index: 2000; display: flex;
          align-items: center; justify-content: center;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
          background: var(--bg-secondary); border-radius: 8px; padding: 20px;
          max-width: 80%; max-height: 80%; overflow: auto; position: relative;
        `;
        
        const header = document.createElement('div');
        header.innerHTML = `
          <h3>${filename}</h3>
          <button onclick="this.closest('.modal').remove()" style="
            position: absolute; top: 10px; right: 15px; background: none;
            border: none; font-size: 20px; cursor: pointer;
          ">&times;</button>
        `;
        
        const body = document.createElement('div');
        
        if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(extension)) {
          body.innerHTML = `<img src="/uploads/${filename}" style="max-width: 100%; height: auto;" alt="${filename}">`;
        } else if (['mp4', 'avi', 'mov', 'mkv', 'webm'].includes(extension)) {
          body.innerHTML = `<video controls style="max-width: 100%; height: auto;"><source src="/uploads/${filename}" type="video/${extension}"></video>`;
        } else if (['mp3', 'wav', 'm4a', 'ogg'].includes(extension)) {
          body.innerHTML = `<audio controls style="width: 100%;"><source src="/uploads/${filename}" type="audio/${extension}"></audio>`;
        } else {
          body.innerHTML = '<div>Loading...</div>';
          fetch(`/uploads/${filename}`)
            .then(response => response.text())
            .then(text => {
              body.innerHTML = `<pre style="white-space: pre-wrap; font-family: monospace; font-size: 14px;">${text}</pre>`;
            })
            .catch(() => {
              body.innerHTML = '<div>Error loading file</div>';
            });
        }
        
        content.appendChild(header);
        content.appendChild(body);
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.remove();
        });
      }
    </script>
  </body>
</html>
